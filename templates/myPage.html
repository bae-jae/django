{% extends 'main.html' %}

<!DOCTYPE html>
{% load static %}


{% block content %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MyPage</title>

    <link rel = "stylesheet" href="{% static 'css/myPage.css' %}"/>
</head>
<body>
    <div style="text-align : center;">
        <img src="../static/img/mypage.jpg" width = '1903'>
    </div>
    
    <section class="cards-wrapper">
        {% for title, img, review, date, writer, mbti in bookInfo %}
          <div class="card-grid-space">
            <!-- <div class="num">01</div> -->
            <a class="myPage_card" onclick="modalOn('{{title}}', 'solve')" style="--bg-img: url({{img}}); background-size:contain; background-repeat: no-repeat;">
              <div>
                <h3 style="color:white">{{writer}}</h3>
                <p class = "review">{{review}}</p>
                <div class="tags">
                  <div class="tag">{{mbti}}</div>
                  <div class="tag">{{date}}</div>
                  <div class="tag" id = "{{title}}" style ="display:none" >PASS</div>
                </div>
              </div>
            </a>
              <div>
                <button class="button">
                      <span class="button__text">
                        <span class="change_review_text" onclick="modalOn('{{title}}', 'write')">리뷰 작성</span>
                      </span>
                      <svg class="button__svg" role="presentational" viewBox="0 0 600 600">
                        <defs>
                          <clipPath id="myClip">
                            <rect x="0" y="0" width="100%" height="50%" />
                          </clipPath>
                        </defs>
                        <g clip-path="url(#myClip)">
                          <g id="money">
                            <path d="M441.9,116.54h-162c-4.66,0-8.49,4.34-8.62,9.83l.85,278.17,178.37,2V126.37C450.38,120.89,446.56,116.52,441.9,116.54Z" fill="#699e64" stroke="#323c44" stroke-miterlimit="10" stroke-width="14" />
                            <path d="M424.73,165.49c-10-2.53-17.38-12-17.68-24H316.44c-.09,11.58-7,21.53-16.62,23.94-3.24.92-5.54,4.29-5.62,8.21V376.54H430.1V173.71C430.15,169.83,427.93,166.43,424.73,165.49Z" fill="#699e64" stroke="#323c44" stroke-miterlimit="10" stroke-width="14" />
                          </g>
                          <g id="creditcard">
                            <path d="M372.12,181.59H210.9c-4.64,0-8.45,4.34-8.58,9.83l.85,278.17,177.49,2V191.42C380.55,185.94,376.75,181.57,372.12,181.59Z" fill="#a76fe2" stroke="#323c44" stroke-miterlimit="10" stroke-width="14" />
                            <path d="M347.55,261.85H332.22c-3.73,0-6.76-3.58-6.76-8v-35.2c0-4.42,3-8,6.76-8h15.33c3.73,0,6.76,3.58,6.76,8v35.2C354.31,258.27,351.28,261.85,347.55,261.85Z" fill="#ffdc67" />
                            <path d="M249.73,183.76h28.85v274.8H249.73Z" fill="#323c44" />
                          </g>
                        </g>
                        <g id="wallet">
                          <path d="M478,288.23h-337A28.93,28.93,0,0,0,112,317.14V546.2a29,29,0,0,0,28.94,28.95H478a29,29,0,0,0,28.95-28.94h0v-229A29,29,0,0,0,478,288.23Z" fill="#a4bdc1" stroke="#323c44" stroke-miterlimit="10" stroke-width="14" />
                          <path d="M512.83,382.71H416.71a28.93,28.93,0,0,0-28.95,28.94h0V467.8a29,29,0,0,0,28.95,28.95h96.12a19.31,19.31,0,0,0,19.3-19.3V402a19.3,19.3,0,0,0-19.3-19.3Z" fill="#a4bdc1" stroke="#323c44" stroke-miterlimit="10" stroke-width="14" />
                          <path d="M451.46,435.79v7.88a14.48,14.48,0,1,1-29,0v-7.9a14.48,14.48,0,0,1,29,0Z" fill="#a4bdc1" stroke="#323c44" stroke-miterlimit="10" stroke-width="14" />
                          <path d="M147.87,541.93V320.84c-.05-13.2,8.25-21.51,21.62-24.27a42.71,42.71,0,0,1,7.14-1.32l-29.36-.63a67.77,67.77,0,0,0-9.13.45c-13.37,2.75-20.32,12.57-20.27,25.77l.38,221.24c-1.57,15.44,8.15,27.08,25.34,26.1l33-.19c-15.9,0-28.78-10.58-28.76-25.93Z" fill="#7b8f91" />
                          <path d="M148.16,343.22a6,6,0,0,0-6,6v92a6,6,0,0,0,12,0v-92A6,6,0,0,0,148.16,343.22Z" fill="#323c44" />
                        </g>
                      </svg>
                </button>
            </div>
              
            <div>
                <button class="button" style="margin-top:1rem">
                      <span class="button__text">
                        <span onclick="modalOn('{{title}}', 'make')">문제 작성</span>
                      </span>
                      <svg class="button__svg" role="presentational" viewBox="0 0 600 600">
                        <defs>
                          <clipPath id="myClip">
                            <rect x="0" y="0" width="100%" height="50%" />
                          </clipPath>
                        </defs>
                        <g clip-path="url(#myClip)">
                          <g id="money">
                            <path d="M441.9,116.54h-162c-4.66,0-8.49,4.34-8.62,9.83l.85,278.17,178.37,2V126.37C450.38,120.89,446.56,116.52,441.9,116.54Z" fill="#699e64" stroke="#323c44" stroke-miterlimit="10" stroke-width="14" />
                            <path d="M424.73,165.49c-10-2.53-17.38-12-17.68-24H316.44c-.09,11.58-7,21.53-16.62,23.94-3.24.92-5.54,4.29-5.62,8.21V376.54H430.1V173.71C430.15,169.83,427.93,166.43,424.73,165.49Z" fill="#699e64" stroke="#323c44" stroke-miterlimit="10" stroke-width="14" />
                          </g>
                          <g id="creditcard">
                            <path d="M372.12,181.59H210.9c-4.64,0-8.45,4.34-8.58,9.83l.85,278.17,177.49,2V191.42C380.55,185.94,376.75,181.57,372.12,181.59Z" fill="#a76fe2" stroke="#323c44" stroke-miterlimit="10" stroke-width="14" />
                            <path d="M347.55,261.85H332.22c-3.73,0-6.76-3.58-6.76-8v-35.2c0-4.42,3-8,6.76-8h15.33c3.73,0,6.76,3.58,6.76,8v35.2C354.31,258.27,351.28,261.85,347.55,261.85Z" fill="#ffdc67" />
                            <path d="M249.73,183.76h28.85v274.8H249.73Z" fill="#323c44" />
                          </g>
                        </g>
                        <g id="wallet">
                          <path d="M478,288.23h-337A28.93,28.93,0,0,0,112,317.14V546.2a29,29,0,0,0,28.94,28.95H478a29,29,0,0,0,28.95-28.94h0v-229A29,29,0,0,0,478,288.23Z" fill="#a4bdc1" stroke="#323c44" stroke-miterlimit="10" stroke-width="14" />
                          <path d="M512.83,382.71H416.71a28.93,28.93,0,0,0-28.95,28.94h0V467.8a29,29,0,0,0,28.95,28.95h96.12a19.31,19.31,0,0,0,19.3-19.3V402a19.3,19.3,0,0,0-19.3-19.3Z" fill="#a4bdc1" stroke="#323c44" stroke-miterlimit="10" stroke-width="14" />
                          <path d="M451.46,435.79v7.88a14.48,14.48,0,1,1-29,0v-7.9a14.48,14.48,0,0,1,29,0Z" fill="#a4bdc1" stroke="#323c44" stroke-miterlimit="10" stroke-width="14" />
                          <path d="M147.87,541.93V320.84c-.05-13.2,8.25-21.51,21.62-24.27a42.71,42.71,0,0,1,7.14-1.32l-29.36-.63a67.77,67.77,0,0,0-9.13.45c-13.37,2.75-20.32,12.57-20.27,25.77l.38,221.24c-1.57,15.44,8.15,27.08,25.34,26.1l33-.19c-15.9,0-28.78-10.58-28.76-25.93Z" fill="#7b8f91" />
                          <path d="M148.16,343.22a6,6,0,0,0-6,6v92a6,6,0,0,0,12,0v-92A6,6,0,0,0,148.16,343.22Z" fill="#323c44" />
                        </g>
                      </svg>
                </button>
            </div>
          </div>
        {% endfor %}   
    </section>
    
    
        <div class="modal" id="modal"> 
            <div class="modal_body">
                <div class="form-group purple-border">
                    <form action="{%url 'myPage:store' name %}"  id = "store" method="POST">
                        {% csrf_token %}
                        <h1 id="modal_bookName" style = "display:inline-block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">MBTI검사</h1>
                        <button class= "right" type='button' onclick="modalOff()">X</button>
                        <textarea class="form-control" name = "review" id="exampleFormControlTextarea4" style="margin: 0px; width: 321px; height: 427px;"></textarea>
                        <span id="modal_delete" type = "submit"><a onclick = "goStore();"></a></span>
                    </form>
                </div>
            </div> 
        </div>
    
    
    
    <!--   문제 모달      -->
    <div class="modal" id= "probModal"> 
        <div class="modal_body">
            <div class="form-group purple-border">
                <h1 id="modal_bookName" style = "display:inline-block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Name</h1>
                
                <form action="#" method="POST">
                    {% csrf_token %}
                    <div class = "mySlides">
                        <textarea class="form-control" name = "review" id="exampleFormControlTextarea4" style="margin: 0px; width: 321px; height: 350px;"></textarea>
                             <input type="radio" name="pprob1" checked>
                             <label for="huey">YES</label>
                        
                             <input type="radio" name="pprob1">
                             <label for="dewey">NO</label>
                        
                        <div>
                            <span id="modal_delete"><a onclick = "nextPage('probModal');"></a></span>
                        </div>
                    </div>
                    <div class = "mySlides">
                        <textarea class="form-control" name = "review" id="exampleFormControlTextarea4" style="margin: 0px; width: 321px; height: 350px;"></textarea>
                        
                        <input type="radio"  name="pprob2" checked>
                             <label for="huey">YES</label>
                        
                             <input type="radio" name="pprob2">
                             <label for="dewey">NO</label>
                        
                        <div>
                            <span id="modal_delete"><a onclick = "nextPage('probModal');"></a></span>
                        </div>
                    </div>
                    
                    <div class = "mySlides">
                        <textarea class="form-control" name = "review" id="exampleFormControlTextarea4" style="margin: 0px; width: 321px; height: 350px;"></textarea>
                        
                            <input type="radio"  name="pprob3" checked>
                            <label for="huey">YES</label>

                            <input type="radio"  name="pprob3">
                            <label for="dewey">NO</label>
                        <div>
                            <span id="modal_delete"><a onclick = "nextPage('probModal');"></a></span>
                        </div>
                        
                    </div>
                    
                    <div class = "mySlides">
                        <span id="modal_delete" type = "submit"><a onclick = "checkAnswer('modal')"></a></span>
                    </div>
                </form>
            </div>
        </div> 
    </div>
    
    <div class="modal" id= "makeModal"> 
        <div class="modal_body">
            <div class="form-group purple-border">
                <h1 id="modal_bookName" style = "display:inline-block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Name</h1>
                <button class= "right" type='button' onclick="modalOff()">X</button>
                <form action= "{% url 'myPage:storeprob' name %}" id = "form" method="POST">
                    {% csrf_token %}
                    <div class = "mySlides">
                        <textarea class="form-control" name = "review" id="exampleFormControlTextarea4" style="margin: 0px; width: 321px; height: 350px;"></textarea>
                        
                             <input type="radio" name="mprob1" checked>
                             <label for="huey">YES</label>
                        
                             <input type="radio" name="mprob1">
                             <label for="dewey">NO</label>
                        
                        <div>
                            <span id="modal_delete"><a onclick = "nextPage('makeModal');"></a></span>
                        </div>
                    </div>
                    
                    <div class = "mySlides">
                        <textarea class="form-control" name = "review" id="exampleFormControlTextarea4" style="margin: 0px; width: 321px; height: 350px;"></textarea>
                        
                        <input type="radio"  name="mprob2" checked>
                             <label for="huey">YES</label>
                        
                             <input type="radio" name="mprob2">
                             <label for="dewey">NO</label>
                        
                        <div>
                            <span id="modal_delete"><a onclick = "nextPage('makeModal');"></a></span>
                        </div>
                    </div>
                    
                    <div class = "mySlides">
                        <textarea class="form-control" name = "review" id="exampleFormControlTextarea4" style="margin: 0px; width: 321px; height: 350px;"></textarea>
                        
                            <input type="radio"  name="mprob3" checked>
                            <label for="huey">YES</label>

                            <input type="radio"  name="mprob3">
                            <label for="dewey">NO</label>
                        <div>
                            <span id="modal_delete"><a onclick = "nextPage('makeModal');"></a></span>
                        </div>
                        
                    </div>
                    
                    <div class = "mySlides">
                        <span id="modal_delete" type = "submit"><a onclick = "goStoreProb()"></a></span>
                    </div>
                </form>
            </div>
        </div> 
    </div>
</body>
    
    <script>
        var cardList = document.getElementsByClassName("card-grid-space");
        var slideIdx = 0;
        var Ans = ""
        //사용자 리뷰 잘라주는 함수
        for(var i = 0; i < cardList.length; ++i)
        {
            review = cardList[i].getElementsByClassName("review")[0];
            
            review.innerHTML = review.innerText;
            review.innerText = review.innerText.replace(/\n/g, "").substring(0, 20) + "...";
        }
        
        //모달켜지는거 알아보줌 
        function modalOn(t, choice){
            
            if(choice == "solve")
            {
                reuslt = []
                obj = document.getElementById("probModal")
                
                {% for title, prob1, prob2, prob3, answer in probList %}
                    if('{{title}}' == t)
                    {
                        dict = {}
                        dict['prob1'] = "{{prob1}}"
                        dict['prob2'] = "{{prob2}}"
                        dict['prob3'] = "{{prob3}}"
                        dict['ans'] = "{{answer}}"

                        reuslt.push(dict)
                    }
                {%endfor%}
                
                slideIdx = 0;
                writeRandom(reuslt, obj);
                nextPage("probModal");
                 
            }
            else if(choice == "write")
            {
                obj = document.getElementById("modal")
            }
            else{
                obj = document.getElementById("makeModal")
                
                slideIdx = 0;
                nextPage("makeModal");
            }
            
            obj.getElementsByTagName("h1")[0].innerText = t
            obj.className = "modalShow"
            window.scrollTo(0, 0);
            
        }
                
        function writeRandom(probList, obj){
            var idx = Math.floor(Math.random() * probList.length) % probList.length
            dict = probList[idx]
            console.log(probList)
            Ans = dict['ans']
            name = "prob"
            x = obj.getElementsByClassName('form-control');
            
            for (i = 0; i < x.length; i++) {
                x[i].innerText = dict[name + (i + 1)]
            }
        }
        
        function nextPage(objId){
              var x = document.getElementById(objId).getElementsByClassName("mySlides");
            
              for (i = 0; i < x.length; i++) {
                x[i].style.display = "none";
              }
            
              x[slideIdx].style.display = "block";
              ++slideIdx;
        }
        
        function checkAnswer(choice){
            modalOff();
            
            var candAns = ""
            var name = "pprob"
            var getTitle = 1;
            var bookName = document.getElementById("probModal").getElementsByTagName("h1")[0].innerText;

            for(var i = 0; i < 3; ++i)
            {
                console.log(name + (i + 1))
                candAns = candAns + answerTrue(document.getElementsByName(name + (i + 1)))
            }
            
            console.log(candAns, Ans)

            if(candAns == Ans)
            {
                document.getElementById(bookName).style.display = "block";
            }
        }
        
        function answerTrue(list){
            
            for(var i = 0; i < list.length; ++i){
                if(list[i].checked){
                    return i;
                }
            }
        }
        
        function modalOff(){
            var modalList = document.getElementsByClassName('modalShow');
            
            for(var i = 0; i < modalList.length; ++i)
            {
                document.getElementsByClassName('modalShow')[i].className = "modal"
            }
            
        }
 
        function goStore(){
            console.log("진입 저장")
             var theForm = document.getElementById('store');
             input = document.createElement('input')
             input.type = 'hidden'
             input.name  = "bookName"; 
             input.id  = "bookName"; 
             input.value  = document.getElementById("modal").getElementsByTagName("h1")[0].innerText; 
             
             theForm.appendChild(input);
             theForm.submit();
        }
        
        //만든 문제를 저장하는 곳
        function goStoreProb(){
             var theForm = document.getElementById('form');
             var textList = theForm.getElementsByClassName('form-control')
             
            for(var i = 0; i < textList.length; ++i)
            {
                input = document.createElement('input')
                input.type = 'hidden'
                input.name  = "prob" + i; 
                input.id  =   "prob" + i;
                input.value  = textList[i].value;
                theForm.appendChild(input);
            }
            
            name = "mprob"
            
            for(var i = 0; i < 3; ++i)
            {
                answer = answerTrue(document.getElementsByName(name + (i + 1)))
                
                input = document.createElement('input')
                input.type = 'hidden'
                input.name  = "mprob" + i; 
                input.id  =   "mprob" + i;
                input.value  = answer + "";
                theForm.appendChild(input);
            }
            
            
            input = document.createElement('input')
            input.type = 'hidden'
            input.name  = "title"; 
            input.id  =   "title" ;
            input.value  = document.getElementById("makeModal").getElementsByTagName("h1")[0].innerText
            console.log(input.value)
            theForm.appendChild(input);
            
            console.log("완료")
            theForm.submit();
        }
        
//         반드시 실행되는 부분
        var reviewList = document.getElementsByClassName('review')
        var changText = document.getElementsByClassName('change_review_text')
            
        for(var i = 0; i < reviewList.length; ++i){
            console.log(reviewList[i].innerText)
            if(reviewList[i].innerText != '리뷰를 작성해주세요...'){
                changText[i].innerText = "리뷰 수정"
            }
        }
        
    </script>
</html>

{% endblock %}